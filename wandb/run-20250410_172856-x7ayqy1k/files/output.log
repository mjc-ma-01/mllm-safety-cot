  0%|          | 0/18036 [00:00<?, ?it/s]
> /mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/transformers/trainer.py(2483)_inner_training_loop()
-> if steps_trained_in_current_epoch > 0:
(Pdb) 0
(Pdb) > /mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/transformers/trainer.py(2503)_inner_training_loop()
-> batch_samples, num_items_in_batch = self.get_batch_samples(epoch_iterator, num_batches)
(Pdb) ([{'input_ids': tensor([[    1,   733, 16289,  ..., 28723,     2,   259]], device='cuda:0'), 'attention_mask': tensor([[1, 1, 1,  ..., 1, 1, 1]], device='cuda:0'), 'pixel_values': tensor([[[[[ 0.2223,  0.3099,  0.3537,  ..., -0.6098, -0.6390, -0.6098],
           [ 0.3683,  0.4413,  0.4705,  ..., -0.0988, -0.1718, -0.2448],
           [ 0.5435,  0.5435,  0.5727,  ...,  0.2953,  0.2661,  0.1931],
           ...,
           [ 0.4997,  0.4413,  0.4267,  ...,  0.9230,  0.9084,  0.8792],
           [ 0.4413,  0.4121,  0.4413,  ...,  0.8355,  0.8501,  0.8792],
           [ 0.3975,  0.4851,  0.4267,  ...,  0.7041,  0.7771,  0.8355]],

          [[-0.2513, -0.2363, -0.2363,  ..., -1.1218, -1.1368, -1.1218],
           [-0.2063, -0.1763, -0.2363,  ..., -0.4464, -0.5365, -0.6115],
           [-0.1913, -0.2363, -0.2363,  ...,  0.0789,  0.0488, -0.0262],
           ...,
           [-0.2363, -0.2813, -0.2813,  ...,  0.1389,  0.1239,  0.0939],
           [-0.2813, -0.3114, -0.2963,  ...,  0.0488,  0.0638,  0.0939],
           [-0.3264, -0.2363, -0.2963,  ..., -0.0862,  0.0188,  0.0789]],

          [[-0.3995, -0.4137, -0.4564,  ..., -1.1105, -1.1105, -1.0678],
           [-0.4990, -0.4706, -0.5133,  ..., -0.6981, -0.7550, -0.7977],
           [-0.5701, -0.5986, -0.5844,  ..., -0.3853, -0.4137, -0.4564],
           ...,
           [-0.8403, -0.8972, -0.9114,  ..., -0.5701, -0.5844, -0.5844],
           [-0.8972, -0.9256, -0.9114,  ..., -0.6555, -0.6412, -0.6128],
           [-0.9256, -0.8545, -0.9114,  ..., -0.7692, -0.7123, -0.6555]]],


         [[[-1.7923, -1.7923, -1.7923,  ..., -1.7923, -1.7923, -1.7923],
           [-1.7923, -1.7923, -1.7923,  ..., -1.7923, -1.7923, -1.7923],
           [-1.7923, -1.7923, -1.7923,  ..., -1.7923, -1.7923, -1.7923],
           ...,
           [-0.5660, -0.6974, -0.8434,  ...,  0.3975,  0.3975,  0.4267],
           [-0.9164, -1.0623, -1.2229,  ...,  0.3829,  0.4121,  0.4267],
           [-1.2083, -1.2083, -1.1937,  ...,  0.3683,  0.3829,  0.4121]],

          [[-1.7521, -1.7521, -1.7521,  ..., -1.7521, -1.7521, -1.7521],
           [-1.7521, -1.7521, -1.7521,  ..., -1.7521, -1.7521, -1.7521],
           [-1.7521, -1.7521, -1.7521,  ..., -1.7521, -1.7521, -1.7521],
           ...,
           [-0.5365, -0.6565, -0.8366,  ..., -0.3114, -0.3114, -0.2813],
           [-0.8967, -1.0617, -1.2268,  ..., -0.3264, -0.2963, -0.2963],
           [-1.2118, -1.2268, -1.2118,  ..., -0.3564, -0.3264, -0.3264]],

          [[-1.4802, -1.4802, -1.4802,  ..., -1.4802, -1.4802, -1.4802],
           [-1.4802, -1.4802, -1.4802,  ..., -1.4802, -1.4802, -1.4802],
           [-1.4802, -1.4802, -1.4802,  ..., -1.4802, -1.4802, -1.4802],
           ...,
           [-0.5844, -0.6839, -0.8119,  ..., -0.6270, -0.6128, -0.5986],
           [-0.8688, -0.9967, -1.1105,  ..., -0.6270, -0.6128, -0.5986],
           [-1.1247, -1.0963, -1.0394,  ..., -0.6555, -0.6412, -0.6270]]],


         [[[-1.7923, -1.7923, -1.7923,  ..., -1.7923, -1.7923, -1.7923],
           [-1.7923, -1.7923, -1.7923,  ..., -1.7923, -1.7923, -1.7923],
           [-1.7923, -1.7923, -1.7923,  ..., -1.7923, -1.7923, -1.7923],
           ...,
           [ 0.3975,  0.3975,  0.4121,  ...,  0.0325,  0.1201,  0.1201],
           [ 0.4267,  0.4121,  0.3975,  ..., -0.1280,  0.0325,  0.1201],
           [ 0.4559,  0.4559,  0.4413,  ..., -0.3908, -0.2010, -0.0696]],

          [[-1.7521, -1.7521, -1.7521,  ..., -1.7521, -1.7521, -1.7521],
           [-1.7521, -1.7521, -1.7521,  ..., -1.7521, -1.7521, -1.7521],
           [-1.7521, -1.7521, -1.7521,  ..., -1.7521, -1.7521, -1.7521],
           ...,
           [-0.2963, -0.3264, -0.2963,  ..., -0.4614, -0.4314, -0.4614],
           [-0.2963, -0.3264, -0.3264,  ..., -0.5515, -0.4014, -0.3564],
           [-0.3264, -0.3264, -0.3264,  ..., -0.7616, -0.5965, -0.4764]],

          [[-1.4802, -1.4802, -1.4802,  ..., -1.4802, -1.4802, -1.4802],
           [-1.4802, -1.4802, -1.4802,  ..., -1.4802, -1.4802, -1.4802],
           [-1.4802, -1.4802, -1.4802,  ..., -1.4802, -1.4802, -1.4802],
           ...,
           [-0.6270, -0.6697, -0.6697,  ..., -0.6981, -0.7123, -0.7834],
           [-0.6128, -0.6412, -0.6555,  ..., -0.7408, -0.6697, -0.6555],
           [-0.6128, -0.6128, -0.6128,  ..., -0.8972, -0.8119, -0.7123]]],


         [[[-1.1645, -1.1791, -1.1791,  ...,  0.4267,  0.4121,  0.4121],
           [-1.1645, -1.1645, -1.1645,  ...,  0.4851,  0.4851,  0.4851],
           [-1.1791, -1.1645, -1.1353,  ...,  0.5143,  0.5289,  0.5289],
           ...,
           [-1.7923, -1.7923, -1.7923,  ..., -1.7923, -1.7923, -1.7923],
           [-1.7923, -1.7923, -1.7923,  ..., -1.7923, -1.7923, -1.7923],
           [-1.7923, -1.7923, -1.7923,  ..., -1.7923, -1.7923, -1.7923]],

          [[-1.1518, -1.1518, -1.1668,  ..., -0.3264, -0.3264, -0.3264],
           [-1.1368, -1.1368, -1.1518,  ..., -0.2813, -0.2663, -0.2813],
           [-1.1668, -1.1518, -1.1368,  ..., -0.2513, -0.2363, -0.2363],
           ...,
           [-1.7521, -1.7521, -1.7521,  ..., -1.7521, -1.7521, -1.7521],
           [-1.7521, -1.7521, -1.7521,  ..., -1.7521, -1.7521, -1.7521],
           [-1.7521, -1.7521, -1.7521,  ..., -1.7521, -1.7521, -1.7521]],

          [[-1.0963, -1.0821, -1.0536,  ..., -0.6555, -0.6412, -0.6412],
           [-1.0678, -1.0536, -1.0252,  ..., -0.6270, -0.6128, -0.6128],
           [-1.0394, -1.0110, -0.9825,  ..., -0.6270, -0.6128, -0.5844],
           ...,
           [-1.4802, -1.4802, -1.4802,  ..., -1.4802, -1.4802, -1.4802],
           [-1.4802, -1.4802, -1.4802,  ..., -1.4802, -1.4802, -1.4802],
           [-1.4802, -1.4802, -1.4802,  ..., -1.4802, -1.4802, -1.4802]]],


         [[[ 0.4267,  0.4413,  0.4705,  ..., -0.5514, -0.5514, -0.4054],
           [ 0.4413,  0.4413,  0.4559,  ..., -0.4638, -0.4638, -0.3324],
           [ 0.4997,  0.4705,  0.4559,  ..., -0.3032, -0.2156, -0.1134],
           ...,
           [-1.7923, -1.7923, -1.7923,  ..., -1.7923, -1.7923, -1.7923],
           [-1.7923, -1.7923, -1.7923,  ..., -1.7923, -1.7923, -1.7923],
           [-1.7923, -1.7923, -1.7923,  ..., -1.7923, -1.7923, -1.7923]],

          [[-0.3714, -0.3564, -0.3414,  ..., -0.8816, -0.9267, -0.7916],
           [-0.3564, -0.3564, -0.3564,  ..., -0.8216, -0.8516, -0.7466],
           [-0.2813, -0.3264, -0.3414,  ..., -0.6715, -0.6115, -0.5215],
           ...,
           [-1.7521, -1.7521, -1.7521,  ..., -1.7521, -1.7521, -1.7521],
           [-1.7521, -1.7521, -1.7521,  ..., -1.7521, -1.7521, -1.7521],
           [-1.7521, -1.7521, -1.7521,  ..., -1.7521, -1.7521, -1.7521]],

          [[-0.6555, -0.6270, -0.6128,  ..., -0.9683, -0.9967, -0.9114],
           [-0.6412, -0.6555, -0.6412,  ..., -0.8830, -0.8972, -0.8119],
           [-0.6128, -0.6412, -0.6697,  ..., -0.7550, -0.6697, -0.5701],
           ...,
           [-1.4802, -1.4802, -1.4802,  ..., -1.4802, -1.4802, -1.4802],
           [-1.4802, -1.4802, -1.4802,  ..., -1.4802, -1.4802, -1.4802],
           [-1.4802, -1.4802, -1.4802,  ..., -1.4802, -1.4802, -1.4802]]]]],
       device='cuda:0'), 'image_sizes': tensor([[375, 500]], device='cuda:0'), 'labels': tensor([[    1,   733, 16289,  ..., 28723,     2,   259]], device='cuda:0')}], 231)
(Pdb)
  File "/mnt/petrelfs/majiachen/project/mllm-safety-cot/src/sft_vlm.py", line 194, in <module>
    trainer.train()
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/transformers/trainer.py", line 2241, in train
    return inner_training_loop(
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/transformers/trainer.py", line 2551, in _inner_training_loop
    tr_loss_step = self.training_step(model, inputs, num_items_in_batch)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/transformers/trainer.py", line 3701, in training_step
    loss = self.compute_loss(model, inputs, num_items_in_batch=num_items_in_batch)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/trl/trainer/sft_trainer.py", line 474, in compute_loss
    (loss, outputs) = super().compute_loss(
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/transformers/trainer.py", line 3762, in compute_loss
    outputs = model(**inputs)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1739, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1750, in _call_impl
    return forward_call(*args, **kwargs)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/deepspeed/utils/nvtx.py", line 18, in wrapped_fn
    ret_val = func(*args, **kwargs)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/deepspeed/runtime/engine.py", line 1914, in forward
    loss = self.module(*inputs, **kwargs)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1739, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1845, in _call_impl
    return inner()
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1793, in inner
    result = forward_call(*args, **kwargs)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/transformers/utils/deprecation.py", line 172, in wrapped_func
    return func(*args, **kwargs)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/transformers/models/llava_next/modeling_llava_next.py", line 653, in forward
    outputs = self.language_model(
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1739, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1845, in _call_impl
    return inner()
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1793, in inner
    result = forward_call(*args, **kwargs)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/transformers/utils/deprecation.py", line 172, in wrapped_func
    return func(*args, **kwargs)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/transformers/models/mistral/modeling_mistral.py", line 843, in forward
    outputs = self.model(
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1739, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1845, in _call_impl
    return inner()
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1793, in inner
    result = forward_call(*args, **kwargs)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/transformers/models/mistral/modeling_mistral.py", line 566, in forward
    layer_outputs = decoder_layer(
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1739, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1845, in _call_impl
    return inner()
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1793, in inner
    result = forward_call(*args, **kwargs)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/transformers/models/mistral/modeling_mistral.py", line 263, in forward
    hidden_states = self.mlp(hidden_states)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1739, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1845, in _call_impl
    return inner()
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1793, in inner
    result = forward_call(*args, **kwargs)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/transformers/models/mistral/modeling_mistral.py", line 57, in forward
    down_proj = self.down_proj(self.act_fn(self.gate_proj(x)) * self.up_proj(x))
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1739, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1845, in _call_impl
    return inner()
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1793, in inner
    result = forward_call(*args, **kwargs)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/linear.py", line 125, in forward
    return F.linear(input, self.weight, self.bias)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/deepspeed/runtime/zero/linear.py", line 116, in zero3_linear_wrap
    return LinearFunctionForZeroStage3.apply(input, weight)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/autograd/function.py", line 575, in apply
    return super().apply(*args, **kwargs)  # type: ignore[misc]
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/amp/autocast_mode.py", line 503, in decorate_fwd
    return fwd(*args, **kwargs)
  File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/deepspeed/runtime/zero/linear.py", line 64, in forward
    output = input.matmul(weight.t())
torch.OutOfMemoryError: CUDA out of memory. Tried to allocate 90.00 MiB. GPU 0 has a total capacity of 79.32 GiB of which 67.56 MiB is free. Including non-PyTorch memory, this process has 79.26 GiB memory in use. Of the allocated memory 78.30 GiB is allocated by PyTorch, and 138.86 MiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables)
[rank0]: Traceback (most recent call last):
[rank0]:   File "/mnt/petrelfs/majiachen/project/mllm-safety-cot/src/sft_vlm.py", line 194, in <module>
[rank0]:     trainer.train()
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/transformers/trainer.py", line 2241, in train
[rank0]:     return inner_training_loop(
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/transformers/trainer.py", line 2551, in _inner_training_loop
[rank0]:     tr_loss_step = self.training_step(model, inputs, num_items_in_batch)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/transformers/trainer.py", line 3701, in training_step
[rank0]:     loss = self.compute_loss(model, inputs, num_items_in_batch=num_items_in_batch)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/trl/trainer/sft_trainer.py", line 474, in compute_loss
[rank0]:     (loss, outputs) = super().compute_loss(
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/transformers/trainer.py", line 3762, in compute_loss
[rank0]:     outputs = model(**inputs)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1739, in _wrapped_call_impl
[rank0]:     return self._call_impl(*args, **kwargs)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1750, in _call_impl
[rank0]:     return forward_call(*args, **kwargs)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/deepspeed/utils/nvtx.py", line 18, in wrapped_fn
[rank0]:     ret_val = func(*args, **kwargs)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/deepspeed/runtime/engine.py", line 1914, in forward
[rank0]:     loss = self.module(*inputs, **kwargs)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1739, in _wrapped_call_impl
[rank0]:     return self._call_impl(*args, **kwargs)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1845, in _call_impl
[rank0]:     return inner()
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1793, in inner
[rank0]:     result = forward_call(*args, **kwargs)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/transformers/utils/deprecation.py", line 172, in wrapped_func
[rank0]:     return func(*args, **kwargs)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/transformers/models/llava_next/modeling_llava_next.py", line 653, in forward
[rank0]:     outputs = self.language_model(
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1739, in _wrapped_call_impl
[rank0]:     return self._call_impl(*args, **kwargs)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1845, in _call_impl
[rank0]:     return inner()
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1793, in inner
[rank0]:     result = forward_call(*args, **kwargs)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/transformers/utils/deprecation.py", line 172, in wrapped_func
[rank0]:     return func(*args, **kwargs)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/transformers/models/mistral/modeling_mistral.py", line 843, in forward
[rank0]:     outputs = self.model(
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1739, in _wrapped_call_impl
[rank0]:     return self._call_impl(*args, **kwargs)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1845, in _call_impl
[rank0]:     return inner()
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1793, in inner
[rank0]:     result = forward_call(*args, **kwargs)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/transformers/models/mistral/modeling_mistral.py", line 566, in forward
[rank0]:     layer_outputs = decoder_layer(
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1739, in _wrapped_call_impl
[rank0]:     return self._call_impl(*args, **kwargs)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1845, in _call_impl
[rank0]:     return inner()
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1793, in inner
[rank0]:     result = forward_call(*args, **kwargs)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/transformers/models/mistral/modeling_mistral.py", line 263, in forward
[rank0]:     hidden_states = self.mlp(hidden_states)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1739, in _wrapped_call_impl
[rank0]:     return self._call_impl(*args, **kwargs)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1845, in _call_impl
[rank0]:     return inner()
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1793, in inner
[rank0]:     result = forward_call(*args, **kwargs)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/transformers/models/mistral/modeling_mistral.py", line 57, in forward
[rank0]:     down_proj = self.down_proj(self.act_fn(self.gate_proj(x)) * self.up_proj(x))
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1739, in _wrapped_call_impl
[rank0]:     return self._call_impl(*args, **kwargs)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1845, in _call_impl
[rank0]:     return inner()
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/module.py", line 1793, in inner
[rank0]:     result = forward_call(*args, **kwargs)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/nn/modules/linear.py", line 125, in forward
[rank0]:     return F.linear(input, self.weight, self.bias)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/deepspeed/runtime/zero/linear.py", line 116, in zero3_linear_wrap
[rank0]:     return LinearFunctionForZeroStage3.apply(input, weight)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/autograd/function.py", line 575, in apply
[rank0]:     return super().apply(*args, **kwargs)  # type: ignore[misc]
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/torch/amp/autocast_mode.py", line 503, in decorate_fwd
[rank0]:     return fwd(*args, **kwargs)
[rank0]:   File "/mnt/petrelfs/majiachen/miniconda3/envs/v-oocr/lib/python3.10/site-packages/deepspeed/runtime/zero/linear.py", line 64, in forward
[rank0]:     output = input.matmul(weight.t())
[rank0]: torch.OutOfMemoryError: CUDA out of memory. Tried to allocate 90.00 MiB. GPU 0 has a total capacity of 79.32 GiB of which 67.56 MiB is free. Including non-PyTorch memory, this process has 79.26 GiB memory in use. Of the allocated memory 78.30 GiB is allocated by PyTorch, and 138.86 MiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables)
